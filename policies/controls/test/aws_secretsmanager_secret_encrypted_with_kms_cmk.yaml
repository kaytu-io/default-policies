ID: aws_secretsmanager_secret_encrypted_with_kms_cmk
Title: Secrets Manager secrets should be encrypted using CMK
Description: Ensure that all secrets in AWS Secrets Manager are encrypted using the
  AWS managed key (aws/secretsmanager) or a customer managed key that was created
  in AWS Key Management Service (AWS KMS). The rule is compliant if a secret is encrypted
  using a customer managed key. This rule is non-compliant if a secret is encrypted
  using aws/secretsmanager.
Query:
  Engine: odysseus-v0.0.1
  QueryToExecute: "    with encryption_keys as (\n      select\n        distinct s.arn,\n
    \       k.aliases as alias\n      from\n        aws_secretsmanager_secret as s\n
    \       left join aws_kms_key as k on k.arn = s.kms_key_id\n      where\n        jsonb_array_length(k.aliases)
    > 0\n    )\n    select\n      s.arn as resource,\n      case\n        when kms_key_id
    is null\n          or kms_key_id = 'alias/aws/secretsmanager'\n          or k.alias
    @> '[{\"AliasName\":\"alias/aws/secretsmanager\"}]'then 'alarm'\n        else
    'ok'\n      end as status,\n      case\n        when kms_key_id is null then title
    || ' not encrypted with KMS.'\n        when kms_key_id = 'alias/aws/secretsmanager'
    or k.alias @> '[{\"AliasName\":\"alias/aws/secretsmanager\"}]' then title || '
    encrypted with AWS managed key.'\n        else title || ' encrypted with CMK.'\n
    \     end as reason\n      \n      \n    from\n      aws_secretsmanager_secret
    as s\n      left join encryption_keys as k on s.arn = k.arn;\n\n"
  Connector:
  - aws
  PrimaryTable: ""
  ListOfTables: []
  Parameters: []
  Global: false
Tags: {}
Severity: ""
