ID: aws_iam_policy_custom_no_blocked_kms_actions
Title: Ensure managed IAM policies should not allow blocked actions on KMS keys
Description: Checks if the managed AWS Identity and Access Management (IAM) policies
  that you create do not allow blocked actions on AWS KMS keys. The rule is non -
  compliant if any blocked action is allowed on AWS KMS keys by the managed IAM policy.
Query:
  Engine: odysseus-v0.0.1
  QueryToExecute: "    with kms_blocked_actions as (\n      select\n        arn,\n
    \       count(*) as statements_num\n      from\n        aws_iam_policy,\n        jsonb_array_elements(policy_std
    -> 'Statement') as s,\n        jsonb_array_elements_text(s -> 'Resource') as resource,\n
    \       jsonb_array_elements_text(s -> 'Action') as action\n      where\n        not
    is_aws_managed\n        and s ->> 'Effect' = 'Allow'\n        and action like
    any(array['kms:decrypt', 'kms:reencryptfrom'])\n      group by\n        arn\n
    \   )\n    select\n      p.arn as resource,\n      case\n        when w.arn is
    null then 'ok'\n        else 'alarm'\n      end status,\n      p.name || ' contains
    ' || coalesce(w.statements_num,0)  || ' statements that allow blocked actions
    on AWS KMS keys.' as reason\n      \n      \n    from\n      aws_iam_policy as
    p\n      left join kms_blocked_actions as w on p.arn = w.arn\n    where\n      not
    p.is_aws_managed;\n"
  Connector:
  - aws
  PrimaryTable: ""
  ListOfTables: []
  Parameters: []
  Global: false
Tags: {}
Severity: ""
