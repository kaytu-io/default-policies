ID: azuread_spn_with_active_client_secret_created_x_days_ago
Title: Service Principal Keys in AzureAD need to comply with Key Rotation Policy
Description: SPNs in AzureAD should not have more than one active Client Secret created X days ago
Query:
  Engine: odysseus-v0.0.1
  QueryToExecute: "with azuread_spn as (\n  select\n    id,\n    display_name,\n    kaytu_account_id,\n    kaytu_resource_id,\n    subscription_id,\n    (\n      select count(*)\n      from jsonb_array_elements(password_credentials) as pc\n      where (value ->> 'EndDateTime')::timestamp > now() AND\n        now() - (pc ->> 'StartDateTime')::timestamp > '{{.azureadClientSecretExpireDays}} days'::interval\n    ) as active_client_secret_count,\n    (\n      select STRING_AGG(pc ->> 'DisplayName', ', ')\n      from jsonb_array_elements(password_credentials) as pc\n      where (value ->> 'EndDateTime')::timestamp > now() AND\n        now() - (pc ->> 'StartDateTime')::timestamp > '{{.azureadClientSecretExpireDays}} days'::interval\n    ) as Ids\n  from\n    azuread_service_principal\n)\nselect\n  id as resource,\n  case\n    when active_client_secret_count > 1 then 'alarm'\n    else 'ok'\n  end as status,\n  case\n    when active_client_secret_count > 0 then display_name || ' has ' || active_client_secret_count || ' active client secrets created {{.azureadClientSecretExpireDays}} days ago: [' || Ids || ']'\n    else display_name || ' has no active client secrets created {{.azureadClientSecretExpireDays}} days ago'\n  end as reason,\n  kaytu_account_id,\n  kaytu_resource_id,\n  subscription_id\nfrom\n  azuread_spn\n"
  Connector:
  - Azure
  PrimaryTable: azuread_service_principal
  ListOfTables:
  - azuread_service_principal
  - azuread_spn
  Parameters:
  - Key: azureadClientSecretExpireDays
    Required: true
  Global: true
ManualVerification: false
Severity: high
Tags:
  score_service_name:
  - Azure Active Directory (Azure AD)
Managed: false
